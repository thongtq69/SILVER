<section class="recently-viewed-section" data-section-id="{{ section.id }}">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="section-heading">{{ section.settings.heading }}</h2>
    {% endif %}
    
    <div class="recently-viewed-grid" id="recently-viewed-products">
      <!-- Products loaded via JavaScript -->
    </div>
    
    <p class="recently-viewed-empty" id="recently-viewed-empty" style="display: none;">
      {{ section.settings.empty_text }}
    </p>
  </div>
</section>

<style>
  .recently-viewed-section {
    padding: var(--spacing-xl) 0;
    background-color: {{ section.settings.background_color }};
  }
  
  .recently-viewed-grid {
    display: grid;
    grid-template-columns: repeat({{ section.settings.columns }}, 1fr);
    gap: var(--spacing-md);
  }
  
  .recently-viewed-item {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  
  .recently-viewed-item:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    transform: translateY(-5px);
  }
  
  .recently-viewed-link {
    display: block;
  }
  
  .recently-viewed-image {
    aspect-ratio: 1;
    overflow: hidden;
    background: #f9f9f9;
  }
  
  .recently-viewed-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .recently-viewed-item:hover .recently-viewed-image img {
    transform: scale(1.05);
  }
  
  .recently-viewed-info {
    padding: var(--spacing-sm);
  }
  
  .recently-viewed-title {
    font-size: 0.9375rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .recently-viewed-price {
    font-weight: 600;
  }
  
  .recently-viewed-empty {
    text-align: center;
    color: #666;
    padding: var(--spacing-lg);
  }
  
  @media (max-width: 1024px) {
    .recently-viewed-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    .recently-viewed-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('recently-viewed-products');
    const emptyMsg = document.getElementById('recently-viewed-empty');
    const maxProducts = {{ section.settings.max_products }};
    
    if (!container) return;
    
    // Get recently viewed from localStorage
    const recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
    
    if (recentlyViewed.length === 0) {
      emptyMsg.style.display = 'block';
      return;
    }
    
    // Render products (limit to max)
    const productsToShow = recentlyViewed.slice(0, maxProducts);
    
    productsToShow.forEach(product => {
      const item = document.createElement('div');
      item.className = 'recently-viewed-item';
      item.innerHTML = `
        <a href="${product.url}" class="recently-viewed-link">
          <div class="recently-viewed-image">
            <img src="${product.image}" alt="${product.title}" loading="lazy">
          </div>
          <div class="recently-viewed-info">
            <h3 class="recently-viewed-title">${product.title}</h3>
            <div class="recently-viewed-price">${product.price}</div>
          </div>
        </a>
      `;
      container.appendChild(item);
    });
  });
  
  // Function to track product views (call this on product pages)
  function trackProductView(product) {
    const maxItems = 10;
    let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
    
    // Remove if already exists
    recentlyViewed = recentlyViewed.filter(p => p.id !== product.id);
    
    // Add to beginning
    recentlyViewed.unshift(product);
    
    // Limit array size
    recentlyViewed = recentlyViewed.slice(0, maxItems);
    
    localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
  }
</script>

{% schema %}
{
  "name": "Recently Viewed",
  "tag": "section",
  "class": "recently-viewed-wrapper",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recently Viewed"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty state text",
      "default": "No recently viewed products"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#fafafa"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 2,
      "max": 8,
      "step": 1,
      "label": "Maximum products to show",
      "default": 4
    },
    {
      "type": "select",
      "id": "columns",
      "label": "Desktop columns",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "4"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed"
    }
  ]
}
{% endschema %}
